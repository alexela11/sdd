<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add User</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>Add User</h2>

  <label>Name</label>
  <input type="text" id="name">

  <label>RFID UID</label>
  <select id="rfid_uid">
    <option value="">Select RFID</option>
  </select>

  <button id="registerFingerprintBtn" disabled>
    Register Fingerprint
  </button>

  <p id="fpStatus" style="margin-top:10px;"></p>

  <a class="link" href="index.html">â¬… Back</a>
</div>
<!-- ERROR MODAL -->
<div id="errorModal" class="modal hidden">
  <div class="modal-content">
    <p>Duplication found. Error occur.</p>
    <button id="errorOkBtn">OK</button>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://fiiflkakeaorglvqyjxx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaWZsa2FrZWFvcmdsdnF5anh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzMxMTcsImV4cCI6MjA4NTE0OTExN30.jWvGfrYhLtXgTKPlLod_TmdavoIAKudeQZ2AT42pVE8";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= ELEMENTS ================= */
const nameInput = document.getElementById("name");
const rfidSelect = document.getElementById("rfid_uid");
const registerBtn = document.getElementById("registerFingerprintBtn");
const fpStatus = document.getElementById("fpStatus");
const errorModal = document.getElementById("errorModal");
const errorOkBtn = document.getElementById("errorOkBtn");


/* ================= STATE ================= */
let requestId = null;

/* ================= ENABLE BUTTON LOGIC ================= */
function checkInputs() {
  registerBtn.disabled =
    !nameInput.value.trim() || !rfidSelect.value;
}

nameInput.addEventListener("input", checkInputs);
rfidSelect.addEventListener("change", checkInputs);

/* ================= LOAD RFID ================= */
async function loadRFIDs() {
  const { data } = await db.from("rfid_cards").select("uid");
  rfidSelect.innerHTML = `<option value="">Select RFID</option>`;
  data.forEach(r => {
    rfidSelect.innerHTML += `<option value="${r.uid}">${r.uid}</option>`;
  });
}
loadRFIDs();

/* ================= REGISTER FINGERPRINT ================= */
registerBtn.addEventListener("click", async () => {

  // ðŸ”’ PREVENT DOUBLE INSERT
  if (requestId) return;

  const name = nameInput.value.trim();
  const rfid = rfidSelect.value;

  if (!name || !rfid) return;


  await db
    .from("fingerprint_requests")
    .delete()
    .eq("status", 2);
  // lock inputs
  
  nameInput.disabled = true;
  rfidSelect.disabled = true;
  registerBtn.disabled = true;

  const { data, error } = await db
    .from("fingerprint_requests")
    .insert({
      name,
      rfid,
      status: 0,       // pending
      is_active: true
    })
    .select()
    .single();

  if (error) {
    alert("Failed to start fingerprint enrollment");
    console.error(error);

    // unlock if failed
    nameInput.disabled = false;
    rfidSelect.disabled = false;
    registerBtn.disabled = false;
    return;
  }

  // ðŸ”¥ SAVE REQUEST ID
  requestId = data.id;

  fpStatus.innerText = "Please scan your finger...";
  pollStatus();
});


/* ================= POLLING ================= */
function pollStatus() {
  const poll = setInterval(async () => {
    if (!requestId) {
      clearInterval(poll);
      return;
    }

    const { data, error } = await db
      .from("fingerprint_requests")
      .select("*")
      .eq("id", requestId)
      .single();

    if (error || !data) return;

    // STATUS 0 â†’ waiting first scan
    if (data.status === 0) {
      fpStatus.innerText = "Please scan your finger...";
      return;
    }

    // STATUS 1 â†’ waiting second scan
    if (data.status === 1) {
      fpStatus.innerText = "Please scan finger again...";
      return;
    }

    // ðŸ”´ STATUS 2 â†’ DUPLICATE / ERROR (FINAL)
    if (data.status === 2) {
      clearInterval(poll);

      // ðŸ”¥ END ENROLLMENT SESSION
      requestId = null;

      errorModal.classList.remove("hidden");

      errorOkBtn.onclick = async () => {
        await db
          .from("fingerprint_requests")
          .update({
            is_active: false,
            deleted_at: new Date().toISOString()
          })
          .eq("id", data.id);

        errorModal.classList.add("hidden");

        // Reset UI
        nameInput.disabled = false;
        rfidSelect.disabled = false;
        registerBtn.disabled = false;

        fpStatus.innerText = "Click Register Fingerprint to try again";
      };

      return;
    }

    // ðŸŸ¢ STATUS 3 â†’ SUCCESS (FINAL)
    if (data.status === 3) {
      clearInterval(poll);

      // ðŸ”¥ END ENROLLMENT SESSION
      requestId = null;

      fpStatus.innerText =
        "Done registering. Going back to main menu...";

      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);

      return;
    }

  }, 2000);
}

</script>

</body>
</html>
