<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add User</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>Add User</h2>

  <label>Name</label>
  <input type="text" id="name">

  <label>RFID UID</label>
  <select id="rfid_uid">
    <option value="">Loading RFID...</option>
  </select>

  <label>Fingerprint</label>
  <button id="registerFingerprintBtn">
    Register Fingerprint
  </button>

  <p id="fpStatus" style="margin-top:10px;"></p>

  <button id="saveBtn">Save</button>
  <a class="link" href="index.html">â¬… Back</a>
</div>

<script>
/* ================= SUPABASE CONFIG ================= */
const SUPABASE_URL = "https://fiiflkakeaorglvqyjxx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaWZsa2FrZWFvcmdsdnF5anh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzMxMTcsImV4cCI6MjA4NTE0OTExN30.jWvGfrYhLtXgTKPlLod_TmdavoIAKudeQZ2AT42pVE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= GLOBAL STATE ================= */
const rfidSelect = document.getElementById("rfid_uid");
const fpStatus = document.getElementById("fpStatus");
let enrolledFingerprintId = null;
let currentCommandId = null; // ðŸŸ¢ FIX: New variable to store the specific command ID

/* ================= LOAD RFID (UNCHANGED) ================= */
async function loadRFIDs() {
  const { data: allRFIDs, error: rfidErr } = await db
    .from("rfid_cards")
    .select("uid");

  if (rfidErr) {
    alert("Failed to load RFID cards");
    console.error(rfidErr);
    return;
  }

  const { data: activeUsers, error: userErr } = await db
    .from("drawer_users")
    .select("rfid_uid")
    .eq("is_active", true);

  if (userErr) {
    alert("Failed to check active users");
    console.error(userErr);
    return;
  }

  const usedRFIDs = new Set(
    activeUsers.map(u => u.rfid_uid).filter(Boolean)
  );

  const availableRFIDs = allRFIDs.filter(
    r => !usedRFIDs.has(r.uid)
  );

  rfidSelect.innerHTML = "";

  if (availableRFIDs.length === 0) {
    rfidSelect.innerHTML =
      `<option value="">No RFID available</option>`;
    return;
  }

  availableRFIDs.forEach(r => {
    rfidSelect.innerHTML +=
      `<option value="${r.uid}">${r.uid}</option>`;
  });
}

loadRFIDs();

/* ================= FINGERPRINT RESULT POLLING (MODIFIED) ================= */
async function waitForFingerprintResult() {
  fpStatus.innerText = "âŒ› Waiting for fingerprint...";

  const interval = setInterval(async () => {
    // ðŸŸ¢ FIX: Query using the specific command_id we just created
    const { data, error } = await db
      .from("device_commands")
      .select("*")
      .eq("id", currentCommandId) // ðŸŸ¢ FIX: Use the specific ID
      .eq("status", "DONE")
      .single();

    // If we have an error or the status isn't DONE yet, just return and poll again
    if (error || !data || data.fingerprint_id === undefined || data.fingerprint_id === null) return;

    enrolledFingerprintId = data.fingerprint_id;

    fpStatus.innerText =
      "âœ… Fingerprint registered (ID: " + enrolledFingerprintId + ")";

    clearInterval(interval);

  }, 2000);
}

/* ================= REGISTER FINGERPRINT (MODIFIED) ================= */
document
  .getElementById("registerFingerprintBtn")
  .addEventListener("click", async () => {

    fpStatus.innerText = "";

    const res = await fetch(
      "https://fiiflkakeaorglvqyjxx.supabase.co/functions/v1/start-fingerprint-enroll",
      {
        method: "POST",
       headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer " + SUPABASE_KEY,
  "apikey": SUPABASE_KEY
},

        body: JSON.stringify({
          device_id: "drawer_01"
        })
      }
    );

    const data = await res.json();
    
    if (data.status === "ENROLL_STARTED") {
      currentCommandId = data.command_id; // ðŸŸ¢ FIX: Capture the new command ID
      alert("ðŸŸ¢ Please place finger on the device");
      waitForFingerprintResult();
    } else {
      alert("âŒ Failed to start enrollment");
      console.log(data);
    }
});

/* ================= SAVE USER ================= */
document.getElementById("saveBtn").addEventListener("click", async () => {
  const name = document.getElementById("name").value.trim();
  const rfid_uid = rfidSelect.value;

  if (!name || !rfid_uid || !enrolledFingerprintId) {
    alert("Please complete all fields and register fingerprint");
    return;
  }

  const { error } = await db
    .from("drawer_users")
    .insert([{
      name,
      rfid_uid,
      fingerprint_id: enrolledFingerprintId,
      is_active: true
    }]);

  if (error) {
    alert("Failed to add user");
    console.error(error);
    return;
  }

  alert("âœ… User added successfully");
  window.location.href = "index.html";
});
</script>

</body>
</html>

