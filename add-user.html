<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add User</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>Add User</h2>

  <label>Name</label>
  <input type="text" id="name">

  <label>RFID UID</label>
  <select id="rfid_uid">
    <option value="">Loading RFID...</option>
  </select>

  <label>Fingerprint ID</label>
  <input type="number" id="fingerprint_id" placeholder="After enrollment">

  <button id="registerFingerprintBtn">
    Register Fingerprint
  </button>

  <button id="saveBtn">Save</button>
  <a class="link" href="index.html">⬅ Back</a>
</div>

<script>
/* ===== SUPABASE CONFIG ===== */
const SUPABASE_URL = "https://fiiflkakeaorglvqyjxx.supabase.co";
const SUPABASE_KEY = "YOUR_ANON_KEY_HERE";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const rfidSelect = document.getElementById("rfid_uid");

/* ===== LOAD AVAILABLE RFID ===== */
async function loadRFIDs() {
  const { data: allRFIDs, error } = await db
    .from("rfid_cards")
    .select("uid");

  if (error) {
    alert("Failed to load RFID");
    return;
  }

  rfidSelect.innerHTML = "";
  allRFIDs.forEach(r => {
    rfidSelect.innerHTML += `<option value="${r.uid}">${r.uid}</option>`;
  });
}

loadRFIDs();

/* ===== REGISTER FINGERPRINT ===== */
document
  .getElementById("registerFingerprintBtn")
  .addEventListener("click", async () => {

    const res = await fetch(
      "https://fiiflkakeaorglvqyjxx.supabase.co/functions/v1/start-fingerprint-enroll",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaWZsa2FrZWFvcmdsdnF5anh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzMxMTcsImV4cCI6MjA4NTE0OTExN30.jWvGfrYhLtXgTKPlLod_TmdavoIAKudeQZ2AT42pVE8"
        },
        body: JSON.stringify({ device_id: "drawer_01" })
      }
    );

    const data = await res.json();

    if (data.status === "ENROLL_STARTED") {
      alert("Place finger on the device");
    } else {
      alert("Failed to start fingerprint enrollment");
    }
});

/* ===== SAVE USER ===== */
document.getElementById("saveBtn").addEventListener("click", async () => {

  const name = document.getElementById("name").value.trim();
  const rfid_uid = rfidSelect.value;
  const fingerprint_id = document.getElementById("fingerprint_id").value;

  if (!name || !rfid_uid || !fingerprint_id) {
    alert("Please fill all fields");
    return;
  }

  const { error } = await db.from("drawer_users").insert([{
    name,
    rfid_uid,
    fingerprint_id,
    is_active: true
  }]);

  if (error) {
    alert("Failed to add user");
    console.error(error);
    return;
  }

  alert("✅ User added successfully");
  window.location.href = "index.html";
});
</script>

</body>
</html>
