<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage User</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
</head>
<body>

<div class="screen">
  <div class="card">

    <h2 id="userName"></h2>
    <p id="userStatus"></p>

    <button id="toggleBtn" class="btn primary"></button>
    <button class="btn primary" onclick="goUpdateRFID()">Update RFID</button>
    <button class="btn secondary" onclick="goHistory()">View History</button>

    <a href="index.html" class="back-link">‚Üê Back</a>

  </div>
</div>

<script>
const SUPABASE_URL = "https://fiiflkakeaorglvqyjxx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaWZsa2FrZWFvcmdsdnF5anh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzMxMTcsImV4cCI6MjA4NTE0OTExN30.jWvGfrYhLtXgTKPlLod_TmdavoIAKudeQZ2AT42pVE8";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const userId = new URLSearchParams(window.location.search).get("id");
let currentUser;

async function loadUser() {
  const { data } = await db
    .from("drawer_users")
    .select("*")
    .eq("id", userId)
    .single();

  currentUser = data;

  userName.textContent = data.name;
  userStatus.textContent = "Status: " + (data.is_active ? "ACTIVE" : "INACTIVE");
  toggleBtn.textContent = data.is_active ? "Deactivate" : "Activate";
}

async function toggleUser() {
  const newStatus = !currentUser.is_active;

  // üîí CHECK RFID CONFLICT WHEN ACTIVATING
  if (newStatus && currentUser.rfid_uid) {
    const { data: conflict } = await db
      .from("drawer_users")
      .select("id")
      .eq("rfid_uid", currentUser.rfid_uid)
      .eq("is_active", true)
      .neq("id", userId)
      .maybeSingle();

    if (conflict) {
      alert("RFID is already used by another ACTIVE user.");
      return;
    }
  }

  // ‚úÖ SAFE TO UPDATE STATUS
  await db
    .from("drawer_users")
    .update({ is_active: newStatus })
    .eq("id", userId);

  loadUser();
}


function goUpdateRFID() {
  location.href = `updaterfid.html?id=${userId}`;
}

function goHistory() {
  location.href = `history.html?id=${userId}`;
}

toggleBtn.onclick = toggleUser;
loadUser();
</script>

</body>
</html>
